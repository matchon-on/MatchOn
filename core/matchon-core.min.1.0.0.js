/**
 * MatchOn JavaScript API
 * 画笔(上海)有限公司
 * @version 1.0.0
 * @license MIT
 */
!function(e,t){"function"==typeof define&&define.amd?define(["MoEventEmitter"],t):"object"==typeof module&&module.exports?module.exports=t(require("MoEventEmitter")):e.MatchOn=t(e.MoEventEmitter)}(this,function(e){"use strict";function t(e){if(this.options=e||{},!this.options.gameID||!this.options.secrete)throw new Error("Parameter Error");if(this.options.matchingServer=this.options.matchingServer||"https://mch.matchon.cn:9191",this.options.messagingServer=this.options.messagingServer||"https://msg.matchon.cn:9292",this.options.timeout=this.options.timeout||60,"string"!=typeof this.options.gameID||"string"!=typeof this.options.secrete||"number"!=typeof this.options.timeout||this.options.timeout<1)throw new Error("New MatchOn Parameter Error");this.test="MatchOn constructed",this.matchingServers=[this.options.matchingServer],this.currentMatchingServer=this.options.matchingServer,this.messagingServers=[this.options.messagingServer],this.currentMessagingServer=this.options.messagingServer,this.moRequest=a.bind(this),this.sendString=o.bind(this)}function r(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e))+e}function a(e,t,a,o,n,i){if(!e||"string"!=typeof e||!t||"string"!=typeof t||!a||"string"!=typeof a)return-1;var c=Date.now(),m=this,p=m.currentMatchingServer,h=new XMLHttpRequest,g=void 0;return h.open(t,p+a,!0),h.setRequestHeader("Content-type","text/plain"),h.setRequestHeader("If-Modified-Since","Thu, 1 Jan 1970 00:00:00 GMT"),h.setRequestHeader("Cache-Control","no-cache"),h.timeout=1e3,h.onreadystatechange=function(u){if(4===h.readyState)switch(h.status){case 308:clearTimeout(g),p=m.currentMatchingServer=JSON.parse(h.responseText).server,Date.now()-c>1e3*m.options.timeout?m.emit(e+"Error",{code:-1,para:n,feedback:i}):g=window.setTimeout(function(){h.open(t,p+a),h.setRequestHeader("Content-type","text/plain"),h.setRequestHeader("If-Modified-Since","Thu, 1 Jan 1970 00:00:00 GMT"),h.setRequestHeader("Cache-Control","no-cache"),h.timeout=1e3,h.send(o)},s);break;case 202:window.clearTimeout(g),g=window.setTimeout(function(){h.open(t,p+a),h.setRequestHeader("Content-type","text/plain"),h.setRequestHeader("If-Modified-Since","Thu, 1 Jan 1970 00:00:00 GMT"),h.setRequestHeader("Cache-Control","no-cache"),h.timeout=1e3,h.send(o)},s);break;case 200:if("init"===e){var y=JSON.parse(h.responseText);m.matchingServers=y.matchingServers,m.currentMatchingServer=m.matchingServers[r(0,m.matchingServers.length)],m.messagingServers=y.messagingServers,m.currentMessagingServer=m.messagingServers[r(0,m.messagingServers.length)],m.emit(e+"Succeeded")}else h.responseText&&""!=h.responseText.trim()?m.emit(e+"Succeeded",{para:n,feedback:i,data:JSON.parse(h.responseText)}):m.emit(e+"Succeeded",{para:n,feedback:i});break;case 0:m.currentMatchingServer=m.matchingServers[r(0,m.matchingServers.length)],p=m.currentMatchingServer,window.clearTimeout(g),Date.now()-c>1e3*m.options.timeout?m.emit(e+"Error",{code:-1,para:n,feedback:i}):g=window.setTimeout(function(){h.open(t,p+a),h.setRequestHeader("Content-type","text/plain"),h.setRequestHeader("If-Modified-Since","Thu, 1 Jan 1970 00:00:00 GMT"),h.setRequestHeader("Cache-Control","no-cache"),h.timeout=1e3,h.send(o)},s);break;default:window.clearTimeout(g),m.emit(e+"Error",{code:h.status,para:n,feedback:i})}},h.onerror=function(u){m.currentMatchingServer=m.matchingServers[r(0,m.matchingServers.length)],p=m.currentMatchingServer,window.clearTimeout(g),Date.now()-c>1e3*m.options.timeout?m.emit(e+"Error",{code:-1,para:n,feedback:i}):g=window.setTimeout(function(){h.open(t,p+a),h.setRequestHeader("Content-type","text/plain"),h.setRequestHeader("If-Modified-Since","Thu, 1 Jan 1970 00:00:00 GMT"),h.setRequestHeader("Cache-Control","no-cache"),h.timeout=1e3,h.send(o)},s)},h.ontimeout=function(u){window.clearTimeout(g),m.currentMatchingServer=m.matchingServers[r(0,m.matchingServers.length)],p=m.currentMatchingServer,Date.now()-c>1e3*m.options.timeout?m.emit(e+"Error",{code:-1,para:n,feedback:i}):g=window.setTimeout(function(){h.open(t,p+a),h.setRequestHeader("Content-type","text/plain"),h.setRequestHeader("If-Modified-Since","Thu, 1 Jan 1970 00:00:00 GMT"),h.setRequestHeader("Cache-Control","no-cache"),h.timeout=1e3,h.send(o)},s)},h.send(o),0}function o(e){return e&&"string"==typeof e&&this.currentSocket?1!=this.currentSocket.readyState?this.currentSocket.readyState:(this.currentSocket.send(e),1):-1}var n,i,s=1e3;return t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.prototype.init=function(e){var t="/servers/"+this.options.gameID+"/"+this.options.secrete;return this.moRequest("init","GET",t,void 0,void 0,e)},t.prototype.newMatch=function(e,t){if(!(e&&e.requestID&&e.playerID&&e.algo))return-1;if("0"!==e.algo&&"1"!==e.algo&&"2"!==e.algo&&"99"!==e.algo)return-1;if(("1"===e.algo||"2"===e.algo)&&!e.para)return-1;if("1"===e.algo||"2"===e.algo){var r=Number(e.para);if(isNaN(r))return-1}var a=JSON.stringify(e);return this.moRequest("newMatch","POST","/match/"+this.options.gameID+"/"+this.options.secrete,a,e,t),0},t.prototype.openSocket=function(e,t){if(!e||!e.playerID||!e.matchID)return-1;var a=this,o=void 0,c=e.connectionType||"/p";if(a.currentSocket&&1===a.currentSocket.readyState)return 1;n=e,i=t;var m=Date.now(),p=new XMLHttpRequest,h=a.currentMessagingServer+"/whichserver/"+a.options.gameID+"/"+a.options.secrete;return p.open("GET",h,!0),p.timeout=1e3*a.options.timeout,p.onload=function(n){if(4===p.readyState)if(200===p.status||308===p.status){window.clearTimeout(o),a.currentMessagingServer=JSON.parse(p.responseText).server;var i="wss://"+a.currentMessagingServer.trim().slice(8)+"/websocket/"+a.options.gameID+"/"+e.playerID+"/"+e.matchID+"/"+a.options.secrete+c,g=new WebSocket(i);g.onopen=function(r){a.currentSocket=g,a.emit("openSocketSucceeded",{para:e,feedback:t})},g.onerror=function(n){Date.now()-m>1e3*a.options.timeout?a.emit("openSocketError",{para:e,feedback:t}):o=window.setTimeout(function(){a.currentMessagingServer=a.messagingServers[r(0,a.messagingServers.length)],h=a.currentMessagingServer+"/whichserver/"+a.options.gameID+"/"+a.options.secrete,p.open("GET",h,!0),p.send(null)},s)},g.onclose=function(r){a.emit("socketClosed",{code:r.code,para:e,feedback:t})},g.onmessage=function(r){a.emit("message",{para:e,feedback:t,message:JSON.parse(r.data)})}}else window.clearTimeout(o),Date.now()-m>1e3*a.options.timeout?a.emit("openSocketError",{code:-1,para:e,feedback:t}):o=window.setTimeout(function(){a.currentMessagingServer=a.messagingServers[r(0,a.messagingServers.length)],h=a.currentMessagingServer+"/whichserver/"+a.options.gameID+"/"+a.options.secrete,p.open("GET",h,!0),p.send(null)},s)},p.onerror=function(n){window.clearTimeout(o),Date.now()-m>1e3*a.options.timeout?a.emit("openSocketError",{code:-1,para:e,feedback:t}):o=window.setTimeout(function(){a.currentMessagingServer=a.messagingServers[r(0,a.messagingServers.length)],h=a.currentMessagingServer+"/whichserver/"+a.options.gameID+"/"+a.options.secrete,p.open("GET",h,!0),p.send(null)},s)},p.ontimeout=function(n){window.clearTimeout(o),Date.now()-m>1e3*a.options.timeout?a.emit("openSocketError",{code:-1,para:e,feedback:t}):o=window.setTimeout(function(){a.currentMessagingServer=a.messagingServers[r(0,a.messagingServers.length)],h=a.currentMessagingServer+"/whichserver/"+a.options.gameID+"/"+a.options.secrete,p.open("GET",h,!0),p.send(null)},s)},p.send(null),0},t.prototype.sendMessage=function(e,t){if(!e||!t||"string"!=typeof e||2!=e.length)return-1;var r=JSON.stringify({type:e,content:t});return this.sendString(r.trim())},t.prototype.getSocketState=function(){return this.currentSocket?this.currentSocket.readyState:-1},t.prototype.disconnect=function(){return this.currentSocket?(this.currentSocket.close(),0):-1},t.prototype.reconnect=function(e){return this.openSocket(n,e||i)},t.prototype.cancelMatchingRequest=function(e,t){if(!(e&&e.cancelID&&e.playerID&&e.originalRequestID&&e.originalAlgo))return-1;var r="/match/"+this.options.gameID+"/"+this.options.secrete,a={requestID:e.cancelID,playerID:e.playerID,algo:e.originalAlgo,para:e.originalRequestID};return clearTimeout(this.retryHandler),this.moRequest("cancelMatching","DELETE",r,JSON.stringify(a),e,t)},t.prototype.joinMatch=function(e,t){if(!(e&&e.requestID&&e.matchID&&e.playerID&&e.algo))return-1;if("99"!==e.algo)return-1;var r=JSON.stringify(e),a="/joinmatch/"+e.matchID+"/"+this.options.gameID+"/"+this.options.secrete;return this.moRequest("joinMatch","POST",a,r,e,t)},t.prototype.getActivePlayers=function(e,t){if(!e||!e.matchID||"string"!=typeof e.matchID)return-1;var r="/activeplayers/"+e.matchID+"/"+this.options.gameID+"/"+this.options.secrete;return this.moRequest("getActivePlayers","GET",r,null,e,t)},t.prototype.getInActivePlayers=function(e,t){if(!e||!e.matchID||"string"!=typeof e.matchID)return-1;var r="/inactiveplayers/"+e.matchID+"/"+this.options.gameID+"/"+this.options.secrete;return this.moRequest("getInActivePlayers","GET",r,null,e,t)},t.prototype.setActive=function(e,t){if(!e||!e.playerID||"string"!=typeof e.playerID||!e.matchID||"string"!=typeof e.matchID)return-1;var r="/setactive/"+e.playerID+"/"+e.matchID+"/"+this.options.gameID+"/"+this.options.secrete;return this.moRequest("setActive","PUT",r,null,e,t)},t.prototype.setInActive=function(e,t){if(!e||!e.playerID||"string"!=typeof e.playerID||!e.matchID||"string"!=typeof e.matchID)return-1;var r="/setinactive/"+e.playerID+"/"+e.matchID+"/"+this.options.gameID+"/"+this.options.secrete;return this.moRequest("setInActive","PUT",r,null,e,t)},t.prototype.playerLastMessage=function(e,t){if(!(e&&e.playerID&&"string"==typeof e.playerID&&e.matchID&&"string"==typeof e.matchID&&e.type&&"string"==typeof e.type))return-1;var r="/lastmatchmsg/"+e.playerID+"/"+e.matchID+"/"+e.type+"/"+this.options.gameID+"/"+this.options.secrete;return this.moRequest("playerLastMessage","GET",r,null,e,t)},t.prototype.playerLastMatch=function(e,t){if(!e||!e.playerID||"string"!=typeof e.playerID)return-1;var r="/lastmatch/"+e.playerID+"/"+e.matchID+"/"+this.options.gameID+"/"+this.options.secrete;return this.moRequest("playerLastMatch","GET",r,null,e,t)},t.prototype.setKV=function(e,t){if(!e||!e.force||"string"!=typeof e.force||!e.domain||"string"!=typeof e.domain||!e.keyName||"string"!=typeof e.keyName||"game"!==e.domain&&"gameMatch"!==e.domain&&"gamePlayer"!==e.domain&&"gamePlayerMatch"!==e.domain)return-1;var r;switch(e.domain){case"game":if(!(e.keyMap&&e.keyMap instanceof Object))return-1;r="/kkv/game/"+e.keyName+"/"+e.force+"/"+this.options.gameID+"/"+this.options.secrete;break;case"gamePlayer":if(!(e.keyMap&&e.keyMap instanceof Object&&e.playerID&&"string"==typeof e.playerID))return-1;r="/kkv/gameplayer/"+e.keyName+"/"+e.force+"/"+e.playerID+"/"+this.options.gameID+"/"+this.options.secrete;break;case"gameMatch":if(!(e.keyMap&&e.keyMap instanceof Object&&e.matchID&&"string"==typeof e.matchID))return-1;r="/kkv/gamematch/"+e.keyName+"/"+e.force+"/"+e.matchID+"/"+this.options.gameID+"/"+this.options.secrete;break;case"gamePlayerMatch":if(!(e.keyMap&&e.keyMap instanceof Object&&e.playerID&&"string"==typeof e.playerID&&e.matchID&&"string"==typeof e.matchID))return-1;r="/kkv/gameplayermatch/"+e.keyName+"/"+e.force+"/"+e.playerID+"/"+e.matchID+"/"+this.options.gameID+"/"+this.options.secrete}return this.moRequest("setKV","POST",r,JSON.stringify(e.keyMap),e,t)},t.prototype.getKV=function(e,t){if(!e||!e.domain||"string"!=typeof e.domain||!e.keyName||"string"!=typeof e.keyName||"game"!=e.domain&&"gamePlayer"!=e.domain&&"gameMatch"!=e.domain&&"gamePlayerMatch"!=e.domain)return-1;var r;switch(e.domain){case"game":r="/kkv/game/"+e.keyName+"/"+this.options.gameID+"/"+this.options.secrete;break;case"gamePlayer":if(!e.playerID||"string"!=typeof e.playerID)return-1;r="/kkv/gameplayer/"+e.keyName+"/"+e.playerID+"/"+this.options.gameID+"/"+this.options.secrete;break;case"gameMatch":if(!e.matchID||"string"!=typeof e.matchID)return-1;r="/kkv/gamematch/"+e.keyName+"/"+e.matchID+"/"+this.options.gameID+"/"+this.options.secrete;break;case"gamePlayerMatch":if(!e.playerID||"string"!=typeof e.playerID||!e.matchID||"string"!=typeof e.matchID)return-1;r="/kkv/gameplayermatch/"+e.keyName+"/"+e.playerID+"/"+e.matchID+"/"+this.options.gameID+"/"+this.options.secrete}return this.moRequest("getKV","GET",r,null,e,t)},t.prototype.deleteKV=function(e,t){if(!(e&&e.domain&&"string"==typeof e.domain&&e.keyName&&"string"==typeof e.keyName&&("game"==e.domain||"gamePlayer"==e.domain||"gameMatch"==e.domain||"gamePlayerMatch"==e.domain)&&e.subKeys&&e.subkeys instanceof Array))return-1;var r;switch(e.domain){case"game":r="/kkv/game/"+e.keyName+"/"+this.options.gameID+"/"+this.options.secrete;break;case"gameMatch":r="/kkv/gamematch/"+e.keyName+"/"+e.matchID+"/"+this.options.gameID+"/"+this.options.secrete;break;case"gamePlayer":r="/kkv/gameplayer/"+e.keyName+"/"+e.playerID+"/"+this.options.gameID+"/"+this.options.secrete;break;case"gamePlayerMatch":r="/kkv/gameplayermatch/"+e.keyName+"/"+e.playerID+"/"+e.matchID+"/"+this.options.gameID+"/"+this.options.secrete}return this.moRequest("deleteKV","DELETE",r,JSON.stringify(e.subKeys),e,t)},t.prototype.checkKVLock=function(e,t){if(!e||!e.domain||"string"!=typeof e.domain||!e.keyName||"string"!=typeof e.keyName||"game"!=e.domain&&"gamePlayer"!=e.domain&&"gameMatch"!=e.domain&&"gamePlayerMatch"!=e.domain)return-1;var r;switch(e.domain){case"game":r="/kkvlock/game/"+e.keyName+"/"+this.options.gameID+"/"+this.options.secrete;break;case"gameMatch":r="/kkvlock/gamematch/"+e.keyName+"/"+e.matchID+"/"+this.options.gameID+"/"+this.options.secrete;break;case"gamePlayer":r="/kkvlock/gameplayer/"+e.keyName+"/"+e.playerID+"/"+this.options.gameID+"/"+this.options.secrete;break;case"gamePlayerMatch":r="/kkvlock/gameplayermatch/"+e.keyName+"/"+e.playerID+"/"+e.matchID+"/"+this.options.gameID+"/"+this.options.secrete}return this.moRequest("checkKVLock","GET",r,null,e,t)},t.prototype.unlockKV=function(e,t){if(!e||!e.domain||"string"!=typeof e.domain||!e.keyName||"string"!=typeof e.keyName||"game"!=e.domain&&"gamePlayer"!=e.domain&&"gameMatch"!=e.domain&&"gamePlayerMatch"!=e.domain)return-1;var r;switch(e.domain){case"game":r="/kkvunlock/game/"+e.keyName+"/"+this.options.gameID+"/"+this.options.secrete;break;case"gameMatch":r="/kkvunlock/gamematch/"+e.keyName+"/"+e.matchID+"/"+this.options.gameID+"/"+this.options.secrete;break;case"gamePlayer":r="/kkvunlock/gameplayer/"+e.keyName+"/"+e.playerID+"/"+this.options.gameID+"/"+this.options.secrete;break;case"gamePlayerMatch":r="/kkvunlock/gameplayermatch/"+e.keyName+"/"+e.playerID+"/"+e.matchID+"/"+this.options.gameID+"/"+this.options.secrete}return this.moRequest("unlockKV","PUT",r,null,e,t)},t.prototype.getLastMatch=function(e,t){if(!e||!e.playerID||"string"!=typeof e.playerID||0===e.playerID.length)return-1;var r="/lastmatch/"+e.playerID+"/"+this.options.gameID+"/"+this.options.secrete;return this.moRequest("getLastMatch","GET",r,null,e,t)},t.prototype.getLastMatchMessage=function(e,t){if(!(e&&e.playerID&&"string"==typeof e.playerID&&0!==e.playerID.length&&e.matchID&&"string"==typeof e.matchID&&0!==e.matchID.length&&e.type&&"string"==typeof e.type&&2==e.type.length))return-1;var r="/lastmatchmsg/"+e.playerID+"/"+e.matchID+"/"+e.type+"/"+this.options.gameID+"/"+this.options.secrete;return this.moRequest("getLastMatchMessage","GET",r,null,e,t)},t});